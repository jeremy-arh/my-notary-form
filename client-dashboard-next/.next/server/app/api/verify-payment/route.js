"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/verify-payment/route";
exports.ids = ["app/api/verify-payment/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "child_process":
/*!********************************!*\
  !*** external "child_process" ***!
  \********************************/
/***/ ((module) => {

module.exports = require("child_process");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "events":
/*!*************************!*\
  !*** external "events" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("events");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

module.exports = require("https");

/***/ }),

/***/ "util":
/*!***********************!*\
  !*** external "util" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("util");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fverify-payment%2Froute&page=%2Fapi%2Fverify-payment%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fverify-payment%2Froute.ts&appDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fverify-payment%2Froute&page=%2Fapi%2Fverify-payment%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fverify-payment%2Froute.ts&appDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var C_Users_jerem_OneDrive_Bureau_Nouveau_dossier_3_my_notary_form_client_dashboard_next_app_api_verify_payment_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/verify-payment/route.ts */ \"(rsc)/./app/api/verify-payment/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/verify-payment/route\",\n        pathname: \"/api/verify-payment\",\n        filename: \"route\",\n        bundlePath: \"app/api/verify-payment/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\jerem\\\\OneDrive\\\\Bureau\\\\Nouveau dossier (3)\\\\my-notary-form\\\\client-dashboard-next\\\\app\\\\api\\\\verify-payment\\\\route.ts\",\n    nextConfigOutput,\n    userland: C_Users_jerem_OneDrive_Bureau_Nouveau_dossier_3_my_notary_form_client_dashboard_next_app_api_verify_payment_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/verify-payment/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZ2ZXJpZnktcGF5bWVudCUyRnJvdXRlJnBhZ2U9JTJGYXBpJTJGdmVyaWZ5LXBheW1lbnQlMkZyb3V0ZSZhcHBQYXRocz0mcGFnZVBhdGg9cHJpdmF0ZS1uZXh0LWFwcC1kaXIlMkZhcGklMkZ2ZXJpZnktcGF5bWVudCUyRnJvdXRlLnRzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNqZXJlbSU1Q09uZURyaXZlJTVDQnVyZWF1JTVDTm91dmVhdSUyMGRvc3NpZXIlMjAoMyklNUNteS1ub3RhcnktZm9ybSU1Q2NsaWVudC1kYXNoYm9hcmQtbmV4dCU1Q2FwcCZwYWdlRXh0ZW5zaW9ucz10c3gmcGFnZUV4dGVuc2lvbnM9dHMmcGFnZUV4dGVuc2lvbnM9anN4JnBhZ2VFeHRlbnNpb25zPWpzJnJvb3REaXI9QyUzQSU1Q1VzZXJzJTVDamVyZW0lNUNPbmVEcml2ZSU1Q0J1cmVhdSU1Q05vdXZlYXUlMjBkb3NzaWVyJTIwKDMpJTVDbXktbm90YXJ5LWZvcm0lNUNjbGllbnQtZGFzaGJvYXJkLW5leHQmaXNEZXY9dHJ1ZSZ0c2NvbmZpZ1BhdGg9dHNjb25maWcuanNvbiZiYXNlUGF0aD0mYXNzZXRQcmVmaXg9Jm5leHRDb25maWdPdXRwdXQ9JnByZWZlcnJlZFJlZ2lvbj0mbWlkZGxld2FyZUNvbmZpZz1lMzAlM0QhIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFzRztBQUN2QztBQUNjO0FBQ2tGO0FBQy9KO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QixnSEFBbUI7QUFDM0M7QUFDQSxjQUFjLHlFQUFTO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxZQUFZO0FBQ1osQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBLFFBQVEsaUVBQWlFO0FBQ3pFO0FBQ0E7QUFDQSxXQUFXLDRFQUFXO0FBQ3RCO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDdUg7O0FBRXZIIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vY2xpZW50LWRhc2hib2FyZC8/MGZiYiJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCJDOlxcXFxVc2Vyc1xcXFxqZXJlbVxcXFxPbmVEcml2ZVxcXFxCdXJlYXVcXFxcTm91dmVhdSBkb3NzaWVyICgzKVxcXFxteS1ub3RhcnktZm9ybVxcXFxjbGllbnQtZGFzaGJvYXJkLW5leHRcXFxcYXBwXFxcXGFwaVxcXFx2ZXJpZnktcGF5bWVudFxcXFxyb3V0ZS50c1wiO1xuLy8gV2UgaW5qZWN0IHRoZSBuZXh0Q29uZmlnT3V0cHV0IGhlcmUgc28gdGhhdCB3ZSBjYW4gdXNlIHRoZW0gaW4gdGhlIHJvdXRlXG4vLyBtb2R1bGUuXG5jb25zdCBuZXh0Q29uZmlnT3V0cHV0ID0gXCJcIlxuY29uc3Qgcm91dGVNb2R1bGUgPSBuZXcgQXBwUm91dGVSb3V0ZU1vZHVsZSh7XG4gICAgZGVmaW5pdGlvbjoge1xuICAgICAgICBraW5kOiBSb3V0ZUtpbmQuQVBQX1JPVVRFLFxuICAgICAgICBwYWdlOiBcIi9hcGkvdmVyaWZ5LXBheW1lbnQvcm91dGVcIixcbiAgICAgICAgcGF0aG5hbWU6IFwiL2FwaS92ZXJpZnktcGF5bWVudFwiLFxuICAgICAgICBmaWxlbmFtZTogXCJyb3V0ZVwiLFxuICAgICAgICBidW5kbGVQYXRoOiBcImFwcC9hcGkvdmVyaWZ5LXBheW1lbnQvcm91dGVcIlxuICAgIH0sXG4gICAgcmVzb2x2ZWRQYWdlUGF0aDogXCJDOlxcXFxVc2Vyc1xcXFxqZXJlbVxcXFxPbmVEcml2ZVxcXFxCdXJlYXVcXFxcTm91dmVhdSBkb3NzaWVyICgzKVxcXFxteS1ub3RhcnktZm9ybVxcXFxjbGllbnQtZGFzaGJvYXJkLW5leHRcXFxcYXBwXFxcXGFwaVxcXFx2ZXJpZnktcGF5bWVudFxcXFxyb3V0ZS50c1wiLFxuICAgIG5leHRDb25maWdPdXRwdXQsXG4gICAgdXNlcmxhbmRcbn0pO1xuLy8gUHVsbCBvdXQgdGhlIGV4cG9ydHMgdGhhdCB3ZSBuZWVkIHRvIGV4cG9zZSBmcm9tIHRoZSBtb2R1bGUuIFRoaXMgc2hvdWxkXG4vLyBiZSBlbGltaW5hdGVkIHdoZW4gd2UndmUgbW92ZWQgdGhlIG90aGVyIHJvdXRlcyB0byB0aGUgbmV3IGZvcm1hdC4gVGhlc2Vcbi8vIGFyZSB1c2VkIHRvIGhvb2sgaW50byB0aGUgcm91dGUuXG5jb25zdCB7IHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzIH0gPSByb3V0ZU1vZHVsZTtcbmNvbnN0IG9yaWdpbmFsUGF0aG5hbWUgPSBcIi9hcGkvdmVyaWZ5LXBheW1lbnQvcm91dGVcIjtcbmZ1bmN0aW9uIHBhdGNoRmV0Y2goKSB7XG4gICAgcmV0dXJuIF9wYXRjaEZldGNoKHtcbiAgICAgICAgc2VydmVySG9va3MsXG4gICAgICAgIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2VcbiAgICB9KTtcbn1cbmV4cG9ydCB7IHJvdXRlTW9kdWxlLCByZXF1ZXN0QXN5bmNTdG9yYWdlLCBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlLCBzZXJ2ZXJIb29rcywgb3JpZ2luYWxQYXRobmFtZSwgcGF0Y2hGZXRjaCwgIH07XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWFwcC1yb3V0ZS5qcy5tYXAiXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fverify-payment%2Froute&page=%2Fapi%2Fverify-payment%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fverify-payment%2Froute.ts&appDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./app/api/verify-payment/route.ts":
/*!*****************************************!*\
  !*** ./app/api/verify-payment/route.ts ***!
  \*****************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var stripe__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! stripe */ \"(rsc)/./node_modules/stripe/esm/stripe.esm.node.js\");\n/* harmony import */ var _lib_supabase_admin__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/supabase/admin */ \"(rsc)/./lib/supabase/admin.ts\");\n/**\r\n * API route to verify Stripe payment.\r\n * Replaces the Supabase Edge Function verify-payment.\r\n */ \n\n\nasync function POST(request) {\n    try {\n        const body = await request.json();\n        const sessionId = body.sessionId;\n        if (!sessionId) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                verified: false,\n                error: \"Missing session ID\"\n            }, {\n                status: 400\n            });\n        }\n        const stripeSecretKey = process.env.STRIPE_SECRET_KEY;\n        if (!stripeSecretKey) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                verified: false,\n                error: \"Missing STRIPE_SECRET_KEY\"\n            }, {\n                status: 500\n            });\n        }\n        const stripe = new stripe__WEBPACK_IMPORTED_MODULE_1__[\"default\"](stripeSecretKey, {\n            apiVersion: \"2023-10-16\"\n        });\n        const supabase = (0,_lib_supabase_admin__WEBPACK_IMPORTED_MODULE_2__.createAdminClient)();\n        const session = await stripe.checkout.sessions.retrieve(sessionId, {\n            expand: [\n                \"payment_intent\",\n                \"invoice\",\n                \"setup_intent\"\n            ]\n        });\n        if (session.payment_status !== \"paid\") {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                verified: false,\n                error: \"Payment not completed\"\n            }, {\n                status: 400\n            });\n        }\n        let invoiceUrl = null;\n        if (session.invoice && typeof session.invoice === \"object\") {\n            invoiceUrl = session.invoice.hosted_invoice_url || session.invoice.invoice_pdf;\n        }\n        if (!invoiceUrl && session.payment_intent && typeof session.payment_intent === \"object\") {\n            const charges = await stripe.charges.list({\n                payment_intent: session.payment_intent.id,\n                limit: 1\n            });\n            if (charges.data.length > 0) {\n                invoiceUrl = charges.data[0].receipt_url ?? null;\n            }\n        }\n        const submissionId = session.metadata?.submission_id;\n        const accountCreated = session.metadata?.account_created === \"true\";\n        if (!submissionId) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                verified: false,\n                error: \"Missing submission ID in payment metadata\"\n            }, {\n                status: 400\n            });\n        }\n        const { data: existingSubmission, error: fetchError } = await supabase.from(\"submission\").select(\"*\").eq(\"id\", submissionId).single();\n        if (fetchError || !existingSubmission) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                verified: false,\n                error: \"Submission not found\"\n            }, {\n                status: 400\n            });\n        }\n        const submission = existingSubmission;\n        const submissionData = submission.data || {};\n        if (submission.status !== \"pending_payment\") {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                verified: true,\n                message: \"Payment already processed\",\n                submission_id: submissionId,\n                submissionId,\n                invoiceUrl,\n                amount: session.amount_total ? session.amount_total / 100 : 0,\n                currency: session.currency?.toUpperCase() ?? \"EUR\",\n                transactionId: sessionId,\n                userData: {\n                    email: submission.email || \"\",\n                    phone: submission.phone || \"\",\n                    firstName: submission.first_name || \"\",\n                    lastName: submission.last_name || \"\",\n                    postalCode: submission.postal_code || \"\",\n                    country: submission.country || \"\"\n                },\n                selectedServices: [],\n                isFirstPurchase: true,\n                servicesCount: 0\n            });\n        }\n        const paymentIntentId = session.payment_intent && typeof session.payment_intent === \"object\" ? session.payment_intent.id : typeof session.payment_intent === \"string\" ? session.payment_intent : null;\n        if (session.customer && paymentIntentId) {\n            try {\n                const customerId = typeof session.customer === \"string\" ? session.customer : session.customer.id;\n                const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId, {\n                    expand: [\n                        \"payment_method\",\n                        \"latest_charge\"\n                    ]\n                });\n                let paymentMethodId = null;\n                if (paymentIntent.payment_method) {\n                    paymentMethodId = typeof paymentIntent.payment_method === \"string\" ? paymentIntent.payment_method : paymentIntent.payment_method.id;\n                }\n                if (!paymentMethodId && paymentIntent.latest_charge) {\n                    const chargeId = typeof paymentIntent.latest_charge === \"string\" ? paymentIntent.latest_charge : paymentIntent.latest_charge.id;\n                    const charge = await stripe.charges.retrieve(chargeId, {\n                        expand: [\n                            \"payment_method\"\n                        ]\n                    });\n                    if (charge.payment_method) {\n                        paymentMethodId = typeof charge.payment_method === \"string\" ? charge.payment_method : charge.payment_method.id;\n                    }\n                }\n                if (!paymentMethodId && session.setup_intent) {\n                    const setupIntentId = typeof session.setup_intent === \"string\" ? session.setup_intent : session.setup_intent.id;\n                    try {\n                        const setupIntent = await stripe.setupIntents.retrieve(setupIntentId, {\n                            expand: [\n                                \"payment_method\"\n                            ]\n                        });\n                        if (setupIntent.payment_method) {\n                            paymentMethodId = typeof setupIntent.payment_method === \"string\" ? setupIntent.payment_method : setupIntent.payment_method.id;\n                        }\n                    } catch  {\n                    /* ignore */ }\n                }\n                if (paymentMethodId) {\n                    try {\n                        const paymentMethod = await stripe.paymentMethods.retrieve(paymentMethodId);\n                        if (!paymentMethod.customer || paymentMethod.customer !== customerId) {\n                            await stripe.paymentMethods.attach(paymentMethodId, {\n                                customer: customerId\n                            });\n                            await stripe.customers.update(customerId, {\n                                invoice_settings: {\n                                    default_payment_method: paymentMethodId\n                                }\n                            });\n                        } else {\n                            await stripe.customers.update(customerId, {\n                                invoice_settings: {\n                                    default_payment_method: paymentMethodId\n                                }\n                            });\n                        }\n                    } catch  {\n                    /* non-critical, continue */ }\n                }\n                // Sauvegarder stripe_customer_id sur le client pour les débits ultérieurs\n                // (cas checkout invité avec customer_email → Stripe crée le customer à la session)\n                if (submission.client_id) {\n                    const { data: clientRow } = await supabase.from(\"client\").select(\"stripe_customer_id\").eq(\"id\", submission.client_id).single();\n                    const currentStripeId = clientRow?.stripe_customer_id;\n                    if (!currentStripeId) {\n                        await supabase.from(\"client\").update({\n                            stripe_customer_id: customerId\n                        }).eq(\"id\", submission.client_id);\n                    }\n                }\n            } catch  {\n            /* non-critical */ }\n        }\n        const updatedData = {\n            ...submissionData,\n            payment: {\n                stripe_session_id: sessionId,\n                payment_intent_id: paymentIntentId,\n                amount_paid: session.amount_total,\n                currency: session.currency,\n                payment_status: session.payment_status,\n                paid_at: new Date().toISOString(),\n                invoice_url: invoiceUrl\n            }\n        };\n        const { data: updatedSubmission, error: updateError } = await supabase.from(\"submission\").update({\n            status: \"pending\",\n            data: updatedData\n        }).eq(\"id\", submissionId).select().single();\n        if (updateError) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                verified: false,\n                error: \"Failed to update submission\"\n            }, {\n                status: 500\n            });\n        }\n        const uploadedFiles = submissionData.uploadedFiles || [];\n        if (uploadedFiles.length > 0) {\n            const fileEntries = uploadedFiles.map((file)=>({\n                    submission_id: submissionId,\n                    file_name: file.name,\n                    file_url: file.public_url,\n                    file_type: file.type,\n                    file_size: file.size,\n                    storage_path: file.storage_path\n                }));\n            await supabase.from(\"submission_files\").insert(fileEntries);\n        }\n        const signatoriesData = submissionData.signatories || submissionData.signatoriesByDocument;\n        if (signatoriesData) {\n            const { data: existingSignatories } = await supabase.from(\"signatories\").select(\"id\").eq(\"submission_id\", submissionId);\n            if (!existingSignatories || existingSignatories.length === 0) {\n                const signatoryEntries = [];\n                const serviceDocuments = submissionData.serviceDocuments || {};\n                const allDocKeys = [];\n                if (typeof serviceDocuments === \"object\") {\n                    Object.entries(serviceDocuments).forEach(([serviceId, documents])=>{\n                        if (Array.isArray(documents)) {\n                            documents.forEach((doc, docIndex)=>{\n                                allDocKeys.push(`${serviceId}_${docIndex}`);\n                            });\n                        }\n                    });\n                }\n                const docKeysToUse = allDocKeys.length > 0 ? allDocKeys : [\n                    \"global\"\n                ];\n                if (Array.isArray(signatoriesData)) {\n                    signatoriesData.forEach((signatory)=>{\n                        if (signatory.firstName && signatory.lastName) {\n                            docKeysToUse.forEach((docKey)=>{\n                                signatoryEntries.push({\n                                    submission_id: submissionId,\n                                    document_key: docKey,\n                                    first_name: signatory.firstName,\n                                    last_name: signatory.lastName,\n                                    birth_date: signatory.birthDate,\n                                    birth_city: signatory.birthCity,\n                                    postal_address: signatory.postalAddress,\n                                    email: signatory.email ?? null,\n                                    phone: signatory.phone ?? null\n                                });\n                            });\n                        }\n                    });\n                } else {\n                    Object.entries(signatoriesData).forEach(([docKey, signatories])=>{\n                        if (Array.isArray(signatories)) {\n                            signatories.forEach((s)=>{\n                                if (s.firstName && s.lastName) {\n                                    signatoryEntries.push({\n                                        submission_id: submissionId,\n                                        document_key: docKey,\n                                        first_name: s.firstName,\n                                        last_name: s.lastName,\n                                        birth_date: s.birthDate,\n                                        birth_city: s.birthCity,\n                                        postal_address: s.postalAddress,\n                                        email: s.email ?? null,\n                                        phone: s.phone ?? null\n                                    });\n                                }\n                            });\n                        }\n                    });\n                }\n                if (signatoryEntries.length > 0) {\n                    await supabase.from(\"signatories\").insert(signatoryEntries);\n                }\n            }\n        }\n        const submissionNumber = submissionId.substring(0, 8);\n        try {\n            const { data: clientData } = await supabase.from(\"client\").select(\"email, first_name, last_name\").eq(\"id\", submission.client_id).single();\n            if (clientData?.email) {\n                const clientName = `${clientData.first_name || \"\"} ${clientData.last_name || \"\"}`.trim() || \"Client\";\n                await supabase.functions.invoke(\"send-transactional-email\", {\n                    body: {\n                        email_type: \"payment_success\",\n                        recipient_email: clientData.email,\n                        recipient_name: clientName,\n                        recipient_type: \"client\",\n                        data: {\n                            submission_id: submissionId,\n                            submission_number: submissionNumber,\n                            payment_amount: session.amount_total ? session.amount_total / 100 : null,\n                            payment_date: new Date().toISOString(),\n                            invoice_url: invoiceUrl\n                        }\n                    }\n                });\n            }\n        } catch  {\n        /* non-critical */ }\n        try {\n            const { data: activeNotaries } = await supabase.from(\"notary\").select(\"id, email, full_name, timezone\").eq(\"is_active\", true);\n            if (activeNotaries && activeNotaries.length > 0) {\n                const clientName = `${submission.first_name || \"\"} ${submission.last_name || \"\"}`.trim() || \"Client\";\n                await Promise.allSettled(activeNotaries.map((notary)=>notary.email ? supabase.functions.invoke(\"send-transactional-email\", {\n                        body: {\n                            email_type: \"new_submission_available\",\n                            recipient_email: notary.email,\n                            recipient_name: notary.full_name || \"Notary\",\n                            recipient_type: \"notary\",\n                            data: {\n                                submission_id: submissionId,\n                                submission_number: submissionNumber,\n                                client_name: clientName,\n                                appointment_date: submission.appointment_date,\n                                appointment_time: submission.appointment_time,\n                                client_timezone: submission.timezone || \"UTC\",\n                                notary_timezone: notary.timezone || \"America/New_York\",\n                                address: submission.address,\n                                city: submission.city,\n                                country: submission.country\n                            }\n                        }\n                    }) : Promise.resolve()));\n            }\n        } catch  {\n        /* non-critical */ }\n        let clientDataForGtm = null;\n        if (submission.client_id) {\n            const { data: client } = await supabase.from(\"client\").select(\"email, phone\").eq(\"id\", submission.client_id).single();\n            if (client) clientDataForGtm = client;\n        }\n        let isFirstPurchase = true;\n        if (submission.client_id) {\n            const { count } = await supabase.from(\"submission\").select(\"*\", {\n                count: \"exact\",\n                head: true\n            }).eq(\"client_id\", submission.client_id).in(\"status\", [\n                \"pending\",\n                \"completed\",\n                \"in_progress\"\n            ]);\n            isFirstPurchase = (count ?? 0) <= 1;\n        }\n        const selectedServiceIds = submissionData.selectedServices || [];\n        let selectedServices = [];\n        if (selectedServiceIds.length > 0) {\n            const { data: services } = await supabase.from(\"services\").select(\"service_id, name, base_price\").in(\"service_id\", selectedServiceIds).eq(\"is_active\", true);\n            if (services && services.length > 0) {\n                selectedServices = services.map((s)=>({\n                        service_id: s.service_id,\n                        id: s.service_id,\n                        name: s.name || \"\",\n                        service_name: s.name || \"\",\n                        price: s.base_price || 0\n                    }));\n            } else {\n                selectedServices = selectedServiceIds.map((sid)=>({\n                        service_id: sid,\n                        id: sid,\n                        name: \"\",\n                        service_name: \"\",\n                        price: 0\n                    }));\n            }\n        }\n        const totalAmount = session.amount_total ? session.amount_total / 100 : 0;\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            verified: true,\n            submissionId: submissionId,\n            accountCreated,\n            invoiceUrl,\n            amount: totalAmount,\n            currency: session.currency ? session.currency.toUpperCase() : \"EUR\",\n            transactionId: sessionId,\n            userData: {\n                email: submission.email || clientDataForGtm?.email || \"\",\n                phone: submission.phone || clientDataForGtm?.phone || \"\",\n                firstName: submission.first_name || \"\",\n                lastName: submission.last_name || \"\",\n                postalCode: submission.postal_code || \"\",\n                country: submission.country || \"\"\n            },\n            selectedServices,\n            isFirstPurchase,\n            servicesCount: selectedServices.length\n        });\n    } catch (error) {\n        console.error(\"[verify-payment] Error:\", error);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            verified: false,\n            error: error instanceof Error ? error.message : \"Verification failed\"\n        }, {\n            status: 400\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUNGLEVBQUUsT0FBT3pCLE9BQU87UUFDZGtMLFFBQVFsTCxLQUFLLENBQUMsMkJBQTJCQTtRQUN6QyxPQUFPVCxxREFBWUEsQ0FBQ00sSUFBSSxDQUN0QjtZQUNFRSxVQUFVO1lBQ1ZDLE9BQU9BLGlCQUFpQm1MLFFBQVFuTCxNQUFNd0MsT0FBTyxHQUFHO1FBQ2xELEdBQ0E7WUFBRXZDLFFBQVE7UUFBSTtJQUVsQjtBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vY2xpZW50LWRhc2hib2FyZC8uL2FwcC9hcGkvdmVyaWZ5LXBheW1lbnQvcm91dGUudHM/ZjBkNiJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQVBJIHJvdXRlIHRvIHZlcmlmeSBTdHJpcGUgcGF5bWVudC5cclxuICogUmVwbGFjZXMgdGhlIFN1cGFiYXNlIEVkZ2UgRnVuY3Rpb24gdmVyaWZ5LXBheW1lbnQuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xyXG5pbXBvcnQgU3RyaXBlIGZyb20gXCJzdHJpcGVcIjtcclxuaW1wb3J0IHsgY3JlYXRlQWRtaW5DbGllbnQgfSBmcm9tIFwiQC9saWIvc3VwYWJhc2UvYWRtaW5cIjtcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcclxuICAgIGNvbnN0IHNlc3Npb25JZCA9IGJvZHkuc2Vzc2lvbklkIGFzIHN0cmluZyB8IHVuZGVmaW5lZDtcclxuXHJcbiAgICBpZiAoIXNlc3Npb25JZCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyB2ZXJpZmllZDogZmFsc2UsIGVycm9yOiBcIk1pc3Npbmcgc2Vzc2lvbiBJRFwiIH0sXHJcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3RyaXBlU2VjcmV0S2V5ID0gcHJvY2Vzcy5lbnYuU1RSSVBFX1NFQ1JFVF9LRVk7XHJcbiAgICBpZiAoIXN0cmlwZVNlY3JldEtleSkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyB2ZXJpZmllZDogZmFsc2UsIGVycm9yOiBcIk1pc3NpbmcgU1RSSVBFX1NFQ1JFVF9LRVlcIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA1MDAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN0cmlwZSA9IG5ldyBTdHJpcGUoc3RyaXBlU2VjcmV0S2V5LCB7IGFwaVZlcnNpb246IFwiMjAyMy0xMC0xNlwiIH0pO1xyXG4gICAgY29uc3Qgc3VwYWJhc2UgPSBjcmVhdGVBZG1pbkNsaWVudCgpO1xyXG5cclxuICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCBzdHJpcGUuY2hlY2tvdXQuc2Vzc2lvbnMucmV0cmlldmUoc2Vzc2lvbklkLCB7XHJcbiAgICAgIGV4cGFuZDogW1wicGF5bWVudF9pbnRlbnRcIiwgXCJpbnZvaWNlXCIsIFwic2V0dXBfaW50ZW50XCJdLFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHNlc3Npb24ucGF5bWVudF9zdGF0dXMgIT09IFwicGFpZFwiKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IHZlcmlmaWVkOiBmYWxzZSwgZXJyb3I6IFwiUGF5bWVudCBub3QgY29tcGxldGVkXCIgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgaW52b2ljZVVybDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XHJcbiAgICBpZiAoc2Vzc2lvbi5pbnZvaWNlICYmIHR5cGVvZiBzZXNzaW9uLmludm9pY2UgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgaW52b2ljZVVybCA9IHNlc3Npb24uaW52b2ljZS5ob3N0ZWRfaW52b2ljZV91cmwgfHwgc2Vzc2lvbi5pbnZvaWNlLmludm9pY2VfcGRmO1xyXG4gICAgfVxyXG4gICAgaWYgKCFpbnZvaWNlVXJsICYmIHNlc3Npb24ucGF5bWVudF9pbnRlbnQgJiYgdHlwZW9mIHNlc3Npb24ucGF5bWVudF9pbnRlbnQgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgY29uc3QgY2hhcmdlcyA9IGF3YWl0IHN0cmlwZS5jaGFyZ2VzLmxpc3Qoe1xyXG4gICAgICAgIHBheW1lbnRfaW50ZW50OiBzZXNzaW9uLnBheW1lbnRfaW50ZW50LmlkLFxyXG4gICAgICAgIGxpbWl0OiAxLFxyXG4gICAgICB9KTtcclxuICAgICAgaWYgKGNoYXJnZXMuZGF0YS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgaW52b2ljZVVybCA9IGNoYXJnZXMuZGF0YVswXS5yZWNlaXB0X3VybCA/PyBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3VibWlzc2lvbklkID0gc2Vzc2lvbi5tZXRhZGF0YT8uc3VibWlzc2lvbl9pZDtcclxuICAgIGNvbnN0IGFjY291bnRDcmVhdGVkID0gc2Vzc2lvbi5tZXRhZGF0YT8uYWNjb3VudF9jcmVhdGVkID09PSBcInRydWVcIjtcclxuXHJcbiAgICBpZiAoIXN1Ym1pc3Npb25JZCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyB2ZXJpZmllZDogZmFsc2UsIGVycm9yOiBcIk1pc3Npbmcgc3VibWlzc2lvbiBJRCBpbiBwYXltZW50IG1ldGFkYXRhXCIgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB7IGRhdGE6IGV4aXN0aW5nU3VibWlzc2lvbiwgZXJyb3I6IGZldGNoRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgIC5mcm9tKFwic3VibWlzc2lvblwiKVxyXG4gICAgICAuc2VsZWN0KFwiKlwiKVxyXG4gICAgICAuZXEoXCJpZFwiLCBzdWJtaXNzaW9uSWQpXHJcbiAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICBpZiAoZmV0Y2hFcnJvciB8fCAhZXhpc3RpbmdTdWJtaXNzaW9uKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IHZlcmlmaWVkOiBmYWxzZSwgZXJyb3I6IFwiU3VibWlzc2lvbiBub3QgZm91bmRcIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN1Ym1pc3Npb24gPSBleGlzdGluZ1N1Ym1pc3Npb24gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XHJcbiAgICBjb25zdCBzdWJtaXNzaW9uRGF0YSA9IChzdWJtaXNzaW9uLmRhdGEgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pIHx8IHt9O1xyXG5cclxuICAgIGlmIChzdWJtaXNzaW9uLnN0YXR1cyAhPT0gXCJwZW5kaW5nX3BheW1lbnRcIikge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgICAgIHZlcmlmaWVkOiB0cnVlLFxyXG4gICAgICAgIG1lc3NhZ2U6IFwiUGF5bWVudCBhbHJlYWR5IHByb2Nlc3NlZFwiLFxyXG4gICAgICAgIHN1Ym1pc3Npb25faWQ6IHN1Ym1pc3Npb25JZCxcclxuICAgICAgICBzdWJtaXNzaW9uSWQsXHJcbiAgICAgICAgaW52b2ljZVVybCxcclxuICAgICAgICBhbW91bnQ6IHNlc3Npb24uYW1vdW50X3RvdGFsID8gc2Vzc2lvbi5hbW91bnRfdG90YWwgLyAxMDAgOiAwLFxyXG4gICAgICAgIGN1cnJlbmN5OiBzZXNzaW9uLmN1cnJlbmN5Py50b1VwcGVyQ2FzZSgpID8/IFwiRVVSXCIsXHJcbiAgICAgICAgdHJhbnNhY3Rpb25JZDogc2Vzc2lvbklkLFxyXG4gICAgICAgIHVzZXJEYXRhOiB7XHJcbiAgICAgICAgICBlbWFpbDogKHN1Ym1pc3Npb24uZW1haWwgYXMgc3RyaW5nKSB8fCBcIlwiLFxyXG4gICAgICAgICAgcGhvbmU6IChzdWJtaXNzaW9uLnBob25lIGFzIHN0cmluZykgfHwgXCJcIixcclxuICAgICAgICAgIGZpcnN0TmFtZTogKHN1Ym1pc3Npb24uZmlyc3RfbmFtZSBhcyBzdHJpbmcpIHx8IFwiXCIsXHJcbiAgICAgICAgICBsYXN0TmFtZTogKHN1Ym1pc3Npb24ubGFzdF9uYW1lIGFzIHN0cmluZykgfHwgXCJcIixcclxuICAgICAgICAgIHBvc3RhbENvZGU6IChzdWJtaXNzaW9uLnBvc3RhbF9jb2RlIGFzIHN0cmluZykgfHwgXCJcIixcclxuICAgICAgICAgIGNvdW50cnk6IChzdWJtaXNzaW9uLmNvdW50cnkgYXMgc3RyaW5nKSB8fCBcIlwiLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2VsZWN0ZWRTZXJ2aWNlczogW10sXHJcbiAgICAgICAgaXNGaXJzdFB1cmNoYXNlOiB0cnVlLFxyXG4gICAgICAgIHNlcnZpY2VzQ291bnQ6IDAsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBheW1lbnRJbnRlbnRJZCA9XHJcbiAgICAgIHNlc3Npb24ucGF5bWVudF9pbnRlbnQgJiYgdHlwZW9mIHNlc3Npb24ucGF5bWVudF9pbnRlbnQgPT09IFwib2JqZWN0XCJcclxuICAgICAgICA/IHNlc3Npb24ucGF5bWVudF9pbnRlbnQuaWRcclxuICAgICAgICA6IHR5cGVvZiBzZXNzaW9uLnBheW1lbnRfaW50ZW50ID09PSBcInN0cmluZ1wiXHJcbiAgICAgICAgICA/IHNlc3Npb24ucGF5bWVudF9pbnRlbnRcclxuICAgICAgICAgIDogbnVsbDtcclxuXHJcbiAgICBpZiAoc2Vzc2lvbi5jdXN0b21lciAmJiBwYXltZW50SW50ZW50SWQpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBjdXN0b21lcklkID0gdHlwZW9mIHNlc3Npb24uY3VzdG9tZXIgPT09IFwic3RyaW5nXCIgPyBzZXNzaW9uLmN1c3RvbWVyIDogc2Vzc2lvbi5jdXN0b21lci5pZDtcclxuICAgICAgICBjb25zdCBwYXltZW50SW50ZW50ID0gYXdhaXQgc3RyaXBlLnBheW1lbnRJbnRlbnRzLnJldHJpZXZlKHBheW1lbnRJbnRlbnRJZCwge1xyXG4gICAgICAgICAgZXhwYW5kOiBbXCJwYXltZW50X21ldGhvZFwiLCBcImxhdGVzdF9jaGFyZ2VcIl0sXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxldCBwYXltZW50TWV0aG9kSWQ6IHN0cmluZyB8IG51bGwgPSBudWxsO1xyXG4gICAgICAgIGlmIChwYXltZW50SW50ZW50LnBheW1lbnRfbWV0aG9kKSB7XHJcbiAgICAgICAgICBwYXltZW50TWV0aG9kSWQgPVxyXG4gICAgICAgICAgICB0eXBlb2YgcGF5bWVudEludGVudC5wYXltZW50X21ldGhvZCA9PT0gXCJzdHJpbmdcIlxyXG4gICAgICAgICAgICAgID8gcGF5bWVudEludGVudC5wYXltZW50X21ldGhvZFxyXG4gICAgICAgICAgICAgIDogcGF5bWVudEludGVudC5wYXltZW50X21ldGhvZC5pZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFwYXltZW50TWV0aG9kSWQgJiYgcGF5bWVudEludGVudC5sYXRlc3RfY2hhcmdlKSB7XHJcbiAgICAgICAgICBjb25zdCBjaGFyZ2VJZCA9XHJcbiAgICAgICAgICAgIHR5cGVvZiBwYXltZW50SW50ZW50LmxhdGVzdF9jaGFyZ2UgPT09IFwic3RyaW5nXCJcclxuICAgICAgICAgICAgICA/IHBheW1lbnRJbnRlbnQubGF0ZXN0X2NoYXJnZVxyXG4gICAgICAgICAgICAgIDogcGF5bWVudEludGVudC5sYXRlc3RfY2hhcmdlLmlkO1xyXG4gICAgICAgICAgY29uc3QgY2hhcmdlID0gYXdhaXQgc3RyaXBlLmNoYXJnZXMucmV0cmlldmUoY2hhcmdlSWQsIHsgZXhwYW5kOiBbXCJwYXltZW50X21ldGhvZFwiXSB9KTtcclxuICAgICAgICAgIGlmIChjaGFyZ2UucGF5bWVudF9tZXRob2QpIHtcclxuICAgICAgICAgICAgcGF5bWVudE1ldGhvZElkID1cclxuICAgICAgICAgICAgICB0eXBlb2YgY2hhcmdlLnBheW1lbnRfbWV0aG9kID09PSBcInN0cmluZ1wiXHJcbiAgICAgICAgICAgICAgICA/IGNoYXJnZS5wYXltZW50X21ldGhvZFxyXG4gICAgICAgICAgICAgICAgOiBjaGFyZ2UucGF5bWVudF9tZXRob2QuaWQ7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghcGF5bWVudE1ldGhvZElkICYmIHNlc3Npb24uc2V0dXBfaW50ZW50KSB7XHJcbiAgICAgICAgICBjb25zdCBzZXR1cEludGVudElkID1cclxuICAgICAgICAgICAgdHlwZW9mIHNlc3Npb24uc2V0dXBfaW50ZW50ID09PSBcInN0cmluZ1wiID8gc2Vzc2lvbi5zZXR1cF9pbnRlbnQgOiBzZXNzaW9uLnNldHVwX2ludGVudC5pZDtcclxuICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNldHVwSW50ZW50ID0gYXdhaXQgc3RyaXBlLnNldHVwSW50ZW50cy5yZXRyaWV2ZShzZXR1cEludGVudElkLCB7XHJcbiAgICAgICAgICAgICAgZXhwYW5kOiBbXCJwYXltZW50X21ldGhvZFwiXSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmIChzZXR1cEludGVudC5wYXltZW50X21ldGhvZCkge1xyXG4gICAgICAgICAgICAgIHBheW1lbnRNZXRob2RJZCA9XHJcbiAgICAgICAgICAgICAgICB0eXBlb2Ygc2V0dXBJbnRlbnQucGF5bWVudF9tZXRob2QgPT09IFwic3RyaW5nXCJcclxuICAgICAgICAgICAgICAgICAgPyBzZXR1cEludGVudC5wYXltZW50X21ldGhvZFxyXG4gICAgICAgICAgICAgICAgICA6IHNldHVwSW50ZW50LnBheW1lbnRfbWV0aG9kLmlkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgICAgLyogaWdub3JlICovXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocGF5bWVudE1ldGhvZElkKSB7XHJcbiAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBwYXltZW50TWV0aG9kID0gYXdhaXQgc3RyaXBlLnBheW1lbnRNZXRob2RzLnJldHJpZXZlKHBheW1lbnRNZXRob2RJZCk7XHJcbiAgICAgICAgICAgIGlmICghcGF5bWVudE1ldGhvZC5jdXN0b21lciB8fCBwYXltZW50TWV0aG9kLmN1c3RvbWVyICE9PSBjdXN0b21lcklkKSB7XHJcbiAgICAgICAgICAgICAgYXdhaXQgc3RyaXBlLnBheW1lbnRNZXRob2RzLmF0dGFjaChwYXltZW50TWV0aG9kSWQsIHsgY3VzdG9tZXI6IGN1c3RvbWVySWQgfSk7XHJcbiAgICAgICAgICAgICAgYXdhaXQgc3RyaXBlLmN1c3RvbWVycy51cGRhdGUoY3VzdG9tZXJJZCwge1xyXG4gICAgICAgICAgICAgICAgaW52b2ljZV9zZXR0aW5nczogeyBkZWZhdWx0X3BheW1lbnRfbWV0aG9kOiBwYXltZW50TWV0aG9kSWQgfSxcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBhd2FpdCBzdHJpcGUuY3VzdG9tZXJzLnVwZGF0ZShjdXN0b21lcklkLCB7XHJcbiAgICAgICAgICAgICAgICBpbnZvaWNlX3NldHRpbmdzOiB7IGRlZmF1bHRfcGF5bWVudF9tZXRob2Q6IHBheW1lbnRNZXRob2RJZCB9LFxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgICAgLyogbm9uLWNyaXRpY2FsLCBjb250aW51ZSAqL1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gU2F1dmVnYXJkZXIgc3RyaXBlX2N1c3RvbWVyX2lkIHN1ciBsZSBjbGllbnQgcG91ciBsZXMgZMOpYml0cyB1bHTDqXJpZXVyc1xyXG4gICAgICAgIC8vIChjYXMgY2hlY2tvdXQgaW52aXTDqSBhdmVjIGN1c3RvbWVyX2VtYWlsIOKGkiBTdHJpcGUgY3LDqWUgbGUgY3VzdG9tZXIgw6AgbGEgc2Vzc2lvbilcclxuICAgICAgICBpZiAoc3VibWlzc2lvbi5jbGllbnRfaWQpIHtcclxuICAgICAgICAgIGNvbnN0IHsgZGF0YTogY2xpZW50Um93IH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgICAgICAuZnJvbShcImNsaWVudFwiKVxyXG4gICAgICAgICAgICAuc2VsZWN0KFwic3RyaXBlX2N1c3RvbWVyX2lkXCIpXHJcbiAgICAgICAgICAgIC5lcShcImlkXCIsIHN1Ym1pc3Npb24uY2xpZW50X2lkKVxyXG4gICAgICAgICAgICAuc2luZ2xlKCk7XHJcbiAgICAgICAgICBjb25zdCBjdXJyZW50U3RyaXBlSWQgPSAoY2xpZW50Um93IGFzIHsgc3RyaXBlX2N1c3RvbWVyX2lkOiBzdHJpbmcgfCBudWxsIH0gfCBudWxsKT8uc3RyaXBlX2N1c3RvbWVyX2lkO1xyXG4gICAgICAgICAgaWYgKCFjdXJyZW50U3RyaXBlSWQpIHtcclxuICAgICAgICAgICAgYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAgICAgICAuZnJvbShcImNsaWVudFwiKVxyXG4gICAgICAgICAgICAgIC51cGRhdGUoeyBzdHJpcGVfY3VzdG9tZXJfaWQ6IGN1c3RvbWVySWQgfSlcclxuICAgICAgICAgICAgICAuZXEoXCJpZFwiLCBzdWJtaXNzaW9uLmNsaWVudF9pZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIHtcclxuICAgICAgICAvKiBub24tY3JpdGljYWwgKi9cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHVwZGF0ZWREYXRhID0ge1xyXG4gICAgICAuLi5zdWJtaXNzaW9uRGF0YSxcclxuICAgICAgcGF5bWVudDoge1xyXG4gICAgICAgIHN0cmlwZV9zZXNzaW9uX2lkOiBzZXNzaW9uSWQsXHJcbiAgICAgICAgcGF5bWVudF9pbnRlbnRfaWQ6IHBheW1lbnRJbnRlbnRJZCxcclxuICAgICAgICBhbW91bnRfcGFpZDogc2Vzc2lvbi5hbW91bnRfdG90YWwsXHJcbiAgICAgICAgY3VycmVuY3k6IHNlc3Npb24uY3VycmVuY3ksXHJcbiAgICAgICAgcGF5bWVudF9zdGF0dXM6IHNlc3Npb24ucGF5bWVudF9zdGF0dXMsXHJcbiAgICAgICAgcGFpZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIGludm9pY2VfdXJsOiBpbnZvaWNlVXJsLFxyXG4gICAgICB9LFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCB7IGRhdGE6IHVwZGF0ZWRTdWJtaXNzaW9uLCBlcnJvcjogdXBkYXRlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgIC5mcm9tKFwic3VibWlzc2lvblwiKVxyXG4gICAgICAudXBkYXRlKHsgc3RhdHVzOiBcInBlbmRpbmdcIiwgZGF0YTogdXBkYXRlZERhdGEgfSlcclxuICAgICAgLmVxKFwiaWRcIiwgc3VibWlzc2lvbklkKVxyXG4gICAgICAuc2VsZWN0KClcclxuICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgIGlmICh1cGRhdGVFcnJvcikge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyB2ZXJpZmllZDogZmFsc2UsIGVycm9yOiBcIkZhaWxlZCB0byB1cGRhdGUgc3VibWlzc2lvblwiIH0sXHJcbiAgICAgICAgeyBzdGF0dXM6IDUwMCB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdXBsb2FkZWRGaWxlcyA9IChzdWJtaXNzaW9uRGF0YS51cGxvYWRlZEZpbGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+W10pIHx8IFtdO1xyXG4gICAgaWYgKHVwbG9hZGVkRmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBmaWxlRW50cmllcyA9IHVwbG9hZGVkRmlsZXMubWFwKChmaWxlOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4gKHtcclxuICAgICAgICBzdWJtaXNzaW9uX2lkOiBzdWJtaXNzaW9uSWQsXHJcbiAgICAgICAgZmlsZV9uYW1lOiBmaWxlLm5hbWUsXHJcbiAgICAgICAgZmlsZV91cmw6IGZpbGUucHVibGljX3VybCxcclxuICAgICAgICBmaWxlX3R5cGU6IGZpbGUudHlwZSxcclxuICAgICAgICBmaWxlX3NpemU6IGZpbGUuc2l6ZSxcclxuICAgICAgICBzdG9yYWdlX3BhdGg6IGZpbGUuc3RvcmFnZV9wYXRoLFxyXG4gICAgICB9KSk7XHJcbiAgICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oXCJzdWJtaXNzaW9uX2ZpbGVzXCIpLmluc2VydChmaWxlRW50cmllcyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc2lnbmF0b3JpZXNEYXRhID0gc3VibWlzc2lvbkRhdGEuc2lnbmF0b3JpZXMgfHwgc3VibWlzc2lvbkRhdGEuc2lnbmF0b3JpZXNCeURvY3VtZW50O1xyXG4gICAgaWYgKHNpZ25hdG9yaWVzRGF0YSkge1xyXG4gICAgICBjb25zdCB7IGRhdGE6IGV4aXN0aW5nU2lnbmF0b3JpZXMgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oXCJzaWduYXRvcmllc1wiKVxyXG4gICAgICAgIC5zZWxlY3QoXCJpZFwiKVxyXG4gICAgICAgIC5lcShcInN1Ym1pc3Npb25faWRcIiwgc3VibWlzc2lvbklkKTtcclxuXHJcbiAgICAgIGlmICghZXhpc3RpbmdTaWduYXRvcmllcyB8fCBleGlzdGluZ1NpZ25hdG9yaWVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIGNvbnN0IHNpZ25hdG9yeUVudHJpZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+W10gPSBbXTtcclxuICAgICAgICBjb25zdCBzZXJ2aWNlRG9jdW1lbnRzID0gKHN1Ym1pc3Npb25EYXRhLnNlcnZpY2VEb2N1bWVudHMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bltdPikgfHwge307XHJcbiAgICAgICAgY29uc3QgYWxsRG9jS2V5czogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlRG9jdW1lbnRzID09PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgICAgICBPYmplY3QuZW50cmllcyhzZXJ2aWNlRG9jdW1lbnRzKS5mb3JFYWNoKChbc2VydmljZUlkLCBkb2N1bWVudHNdKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRvY3VtZW50cykpIHtcclxuICAgICAgICAgICAgICBkb2N1bWVudHMuZm9yRWFjaCgoZG9jOiB1bmtub3duLCBkb2NJbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBhbGxEb2NLZXlzLnB1c2goYCR7c2VydmljZUlkfV8ke2RvY0luZGV4fWApO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZG9jS2V5c1RvVXNlID0gYWxsRG9jS2V5cy5sZW5ndGggPiAwID8gYWxsRG9jS2V5cyA6IFtcImdsb2JhbFwiXTtcclxuXHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2lnbmF0b3JpZXNEYXRhKSkge1xyXG4gICAgICAgICAgc2lnbmF0b3JpZXNEYXRhLmZvckVhY2goKHNpZ25hdG9yeTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pID0+IHtcclxuICAgICAgICAgICAgaWYgKHNpZ25hdG9yeS5maXJzdE5hbWUgJiYgc2lnbmF0b3J5Lmxhc3ROYW1lKSB7XHJcbiAgICAgICAgICAgICAgZG9jS2V5c1RvVXNlLmZvckVhY2goKGRvY0tleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgc2lnbmF0b3J5RW50cmllcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgc3VibWlzc2lvbl9pZDogc3VibWlzc2lvbklkLFxyXG4gICAgICAgICAgICAgICAgICBkb2N1bWVudF9rZXk6IGRvY0tleSxcclxuICAgICAgICAgICAgICAgICAgZmlyc3RfbmFtZTogc2lnbmF0b3J5LmZpcnN0TmFtZSxcclxuICAgICAgICAgICAgICAgICAgbGFzdF9uYW1lOiBzaWduYXRvcnkubGFzdE5hbWUsXHJcbiAgICAgICAgICAgICAgICAgIGJpcnRoX2RhdGU6IHNpZ25hdG9yeS5iaXJ0aERhdGUsXHJcbiAgICAgICAgICAgICAgICAgIGJpcnRoX2NpdHk6IHNpZ25hdG9yeS5iaXJ0aENpdHksXHJcbiAgICAgICAgICAgICAgICAgIHBvc3RhbF9hZGRyZXNzOiBzaWduYXRvcnkucG9zdGFsQWRkcmVzcyxcclxuICAgICAgICAgICAgICAgICAgZW1haWw6IHNpZ25hdG9yeS5lbWFpbCA/PyBudWxsLFxyXG4gICAgICAgICAgICAgICAgICBwaG9uZTogc2lnbmF0b3J5LnBob25lID8/IG51bGwsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHNpZ25hdG9yaWVzRGF0YSkuZm9yRWFjaCgoW2RvY0tleSwgc2lnbmF0b3JpZXNdKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNpZ25hdG9yaWVzKSkge1xyXG4gICAgICAgICAgICAgIHNpZ25hdG9yaWVzLmZvckVhY2goKHM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocy5maXJzdE5hbWUgJiYgcy5sYXN0TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICBzaWduYXRvcnlFbnRyaWVzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHN1Ym1pc3Npb25faWQ6IHN1Ym1pc3Npb25JZCxcclxuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudF9rZXk6IGRvY0tleSxcclxuICAgICAgICAgICAgICAgICAgICBmaXJzdF9uYW1lOiBzLmZpcnN0TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBsYXN0X25hbWU6IHMubGFzdE5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgYmlydGhfZGF0ZTogcy5iaXJ0aERhdGUsXHJcbiAgICAgICAgICAgICAgICAgICAgYmlydGhfY2l0eTogcy5iaXJ0aENpdHksXHJcbiAgICAgICAgICAgICAgICAgICAgcG9zdGFsX2FkZHJlc3M6IHMucG9zdGFsQWRkcmVzcyxcclxuICAgICAgICAgICAgICAgICAgICBlbWFpbDogcy5lbWFpbCA/PyBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHBob25lOiBzLnBob25lID8/IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNpZ25hdG9yeUVudHJpZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbShcInNpZ25hdG9yaWVzXCIpLmluc2VydChzaWduYXRvcnlFbnRyaWVzKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdWJtaXNzaW9uTnVtYmVyID0gc3VibWlzc2lvbklkLnN1YnN0cmluZygwLCA4KTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGRhdGE6IGNsaWVudERhdGEgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oXCJjbGllbnRcIilcclxuICAgICAgICAuc2VsZWN0KFwiZW1haWwsIGZpcnN0X25hbWUsIGxhc3RfbmFtZVwiKVxyXG4gICAgICAgIC5lcShcImlkXCIsIHN1Ym1pc3Npb24uY2xpZW50X2lkKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGlmIChjbGllbnREYXRhPy5lbWFpbCkge1xyXG4gICAgICAgIGNvbnN0IGNsaWVudE5hbWUgPSBgJHsoY2xpZW50RGF0YS5maXJzdF9uYW1lIGFzIHN0cmluZykgfHwgXCJcIn0gJHsoY2xpZW50RGF0YS5sYXN0X25hbWUgYXMgc3RyaW5nKSB8fCBcIlwifWAudHJpbSgpIHx8IFwiQ2xpZW50XCI7XHJcbiAgICAgICAgYXdhaXQgc3VwYWJhc2UuZnVuY3Rpb25zLmludm9rZShcInNlbmQtdHJhbnNhY3Rpb25hbC1lbWFpbFwiLCB7XHJcbiAgICAgICAgICBib2R5OiB7XHJcbiAgICAgICAgICAgIGVtYWlsX3R5cGU6IFwicGF5bWVudF9zdWNjZXNzXCIsXHJcbiAgICAgICAgICAgIHJlY2lwaWVudF9lbWFpbDogY2xpZW50RGF0YS5lbWFpbCxcclxuICAgICAgICAgICAgcmVjaXBpZW50X25hbWU6IGNsaWVudE5hbWUsXHJcbiAgICAgICAgICAgIHJlY2lwaWVudF90eXBlOiBcImNsaWVudFwiLFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgc3VibWlzc2lvbl9pZDogc3VibWlzc2lvbklkLFxyXG4gICAgICAgICAgICAgIHN1Ym1pc3Npb25fbnVtYmVyOiBzdWJtaXNzaW9uTnVtYmVyLFxyXG4gICAgICAgICAgICAgIHBheW1lbnRfYW1vdW50OiBzZXNzaW9uLmFtb3VudF90b3RhbCA/IHNlc3Npb24uYW1vdW50X3RvdGFsIC8gMTAwIDogbnVsbCxcclxuICAgICAgICAgICAgICBwYXltZW50X2RhdGU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICAgICAgICBpbnZvaWNlX3VybDogaW52b2ljZVVybCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICAvKiBub24tY3JpdGljYWwgKi9cclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGRhdGE6IGFjdGl2ZU5vdGFyaWVzIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKFwibm90YXJ5XCIpXHJcbiAgICAgICAgLnNlbGVjdChcImlkLCBlbWFpbCwgZnVsbF9uYW1lLCB0aW1lem9uZVwiKVxyXG4gICAgICAgIC5lcShcImlzX2FjdGl2ZVwiLCB0cnVlKTtcclxuXHJcbiAgICAgIGlmIChhY3RpdmVOb3RhcmllcyAmJiBhY3RpdmVOb3Rhcmllcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgY2xpZW50TmFtZSA9IGAkeyhzdWJtaXNzaW9uLmZpcnN0X25hbWUgYXMgc3RyaW5nKSB8fCBcIlwifSAkeyhzdWJtaXNzaW9uLmxhc3RfbmFtZSBhcyBzdHJpbmcpIHx8IFwiXCJ9YC50cmltKCkgfHwgXCJDbGllbnRcIjtcclxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoXHJcbiAgICAgICAgICBhY3RpdmVOb3Rhcmllcy5tYXAoKG5vdGFyeSkgPT5cclxuICAgICAgICAgICAgbm90YXJ5LmVtYWlsXHJcbiAgICAgICAgICAgICAgPyBzdXBhYmFzZS5mdW5jdGlvbnMuaW52b2tlKFwic2VuZC10cmFuc2FjdGlvbmFsLWVtYWlsXCIsIHtcclxuICAgICAgICAgICAgICAgICAgYm9keToge1xyXG4gICAgICAgICAgICAgICAgICAgIGVtYWlsX3R5cGU6IFwibmV3X3N1Ym1pc3Npb25fYXZhaWxhYmxlXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVjaXBpZW50X2VtYWlsOiBub3RhcnkuZW1haWwsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVjaXBpZW50X25hbWU6IChub3RhcnkuZnVsbF9uYW1lIGFzIHN0cmluZykgfHwgXCJOb3RhcnlcIixcclxuICAgICAgICAgICAgICAgICAgICByZWNpcGllbnRfdHlwZTogXCJub3RhcnlcIixcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBzdWJtaXNzaW9uX2lkOiBzdWJtaXNzaW9uSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICBzdWJtaXNzaW9uX251bWJlcjogc3VibWlzc2lvbk51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICAgIGNsaWVudF9uYW1lOiBjbGllbnROYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgYXBwb2ludG1lbnRfZGF0ZTogc3VibWlzc2lvbi5hcHBvaW50bWVudF9kYXRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgYXBwb2ludG1lbnRfdGltZTogc3VibWlzc2lvbi5hcHBvaW50bWVudF90aW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgY2xpZW50X3RpbWV6b25lOiAoc3VibWlzc2lvbi50aW1lem9uZSBhcyBzdHJpbmcpIHx8IFwiVVRDXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBub3RhcnlfdGltZXpvbmU6IChub3RhcnkudGltZXpvbmUgYXMgc3RyaW5nKSB8fCBcIkFtZXJpY2EvTmV3X1lvcmtcIixcclxuICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IHN1Ym1pc3Npb24uYWRkcmVzcyxcclxuICAgICAgICAgICAgICAgICAgICAgIGNpdHk6IHN1Ym1pc3Npb24uY2l0eSxcclxuICAgICAgICAgICAgICAgICAgICAgIGNvdW50cnk6IHN1Ym1pc3Npb24uY291bnRyeSxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICA6IFByb21pc2UucmVzb2x2ZSgpXHJcbiAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCB7XHJcbiAgICAgIC8qIG5vbi1jcml0aWNhbCAqL1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBjbGllbnREYXRhRm9yR3RtOiB7IGVtYWlsPzogc3RyaW5nOyBwaG9uZT86IHN0cmluZyB9IHwgbnVsbCA9IG51bGw7XHJcbiAgICBpZiAoc3VibWlzc2lvbi5jbGllbnRfaWQpIHtcclxuICAgICAgY29uc3QgeyBkYXRhOiBjbGllbnQgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgLmZyb20oXCJjbGllbnRcIilcclxuICAgICAgICAuc2VsZWN0KFwiZW1haWwsIHBob25lXCIpXHJcbiAgICAgICAgLmVxKFwiaWRcIiwgc3VibWlzc2lvbi5jbGllbnRfaWQpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG4gICAgICBpZiAoY2xpZW50KSBjbGllbnREYXRhRm9yR3RtID0gY2xpZW50IGFzIHsgZW1haWw/OiBzdHJpbmc7IHBob25lPzogc3RyaW5nIH07XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGlzRmlyc3RQdXJjaGFzZSA9IHRydWU7XHJcbiAgICBpZiAoc3VibWlzc2lvbi5jbGllbnRfaWQpIHtcclxuICAgICAgY29uc3QgeyBjb3VudCB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAuZnJvbShcInN1Ym1pc3Npb25cIilcclxuICAgICAgICAuc2VsZWN0KFwiKlwiLCB7IGNvdW50OiBcImV4YWN0XCIsIGhlYWQ6IHRydWUgfSlcclxuICAgICAgICAuZXEoXCJjbGllbnRfaWRcIiwgc3VibWlzc2lvbi5jbGllbnRfaWQpXHJcbiAgICAgICAgLmluKFwic3RhdHVzXCIsIFtcInBlbmRpbmdcIiwgXCJjb21wbGV0ZWRcIiwgXCJpbl9wcm9ncmVzc1wiXSk7XHJcbiAgICAgIGlzRmlyc3RQdXJjaGFzZSA9IChjb3VudCA/PyAwKSA8PSAxO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNlbGVjdGVkU2VydmljZUlkcyA9IChzdWJtaXNzaW9uRGF0YS5zZWxlY3RlZFNlcnZpY2VzIGFzIHN0cmluZ1tdKSB8fCBbXTtcclxuICAgIGxldCBzZWxlY3RlZFNlcnZpY2VzOiBBcnJheTx7IHNlcnZpY2VfaWQ6IHN0cmluZzsgaWQ6IHN0cmluZzsgbmFtZTogc3RyaW5nOyBzZXJ2aWNlX25hbWU6IHN0cmluZzsgcHJpY2U6IG51bWJlciB9PiA9IFtdO1xyXG5cclxuICAgIGlmIChzZWxlY3RlZFNlcnZpY2VJZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCB7IGRhdGE6IHNlcnZpY2VzIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgIC5mcm9tKFwic2VydmljZXNcIilcclxuICAgICAgICAuc2VsZWN0KFwic2VydmljZV9pZCwgbmFtZSwgYmFzZV9wcmljZVwiKVxyXG4gICAgICAgIC5pbihcInNlcnZpY2VfaWRcIiwgc2VsZWN0ZWRTZXJ2aWNlSWRzKVxyXG4gICAgICAgIC5lcShcImlzX2FjdGl2ZVwiLCB0cnVlKTtcclxuXHJcbiAgICAgIGlmIChzZXJ2aWNlcyAmJiBzZXJ2aWNlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgc2VsZWN0ZWRTZXJ2aWNlcyA9IHNlcnZpY2VzLm1hcCgocykgPT4gKHtcclxuICAgICAgICAgIHNlcnZpY2VfaWQ6IHMuc2VydmljZV9pZCxcclxuICAgICAgICAgIGlkOiBzLnNlcnZpY2VfaWQsXHJcbiAgICAgICAgICBuYW1lOiAocy5uYW1lIGFzIHN0cmluZykgfHwgXCJcIixcclxuICAgICAgICAgIHNlcnZpY2VfbmFtZTogKHMubmFtZSBhcyBzdHJpbmcpIHx8IFwiXCIsXHJcbiAgICAgICAgICBwcmljZTogKHMuYmFzZV9wcmljZSBhcyBudW1iZXIpIHx8IDAsXHJcbiAgICAgICAgfSkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHNlbGVjdGVkU2VydmljZXMgPSBzZWxlY3RlZFNlcnZpY2VJZHMubWFwKChzaWQpID0+ICh7XHJcbiAgICAgICAgICBzZXJ2aWNlX2lkOiBzaWQsXHJcbiAgICAgICAgICBpZDogc2lkLFxyXG4gICAgICAgICAgbmFtZTogXCJcIixcclxuICAgICAgICAgIHNlcnZpY2VfbmFtZTogXCJcIixcclxuICAgICAgICAgIHByaWNlOiAwLFxyXG4gICAgICAgIH0pKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRvdGFsQW1vdW50ID0gc2Vzc2lvbi5hbW91bnRfdG90YWwgPyBzZXNzaW9uLmFtb3VudF90b3RhbCAvIDEwMCA6IDA7XHJcblxyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcclxuICAgICAgdmVyaWZpZWQ6IHRydWUsXHJcbiAgICAgIHN1Ym1pc3Npb25JZDogc3VibWlzc2lvbklkLFxyXG4gICAgICBhY2NvdW50Q3JlYXRlZCxcclxuICAgICAgaW52b2ljZVVybCxcclxuICAgICAgYW1vdW50OiB0b3RhbEFtb3VudCxcclxuICAgICAgY3VycmVuY3k6IHNlc3Npb24uY3VycmVuY3kgPyBzZXNzaW9uLmN1cnJlbmN5LnRvVXBwZXJDYXNlKCkgOiBcIkVVUlwiLFxyXG4gICAgICB0cmFuc2FjdGlvbklkOiBzZXNzaW9uSWQsXHJcbiAgICAgIHVzZXJEYXRhOiB7XHJcbiAgICAgICAgZW1haWw6IChzdWJtaXNzaW9uLmVtYWlsIGFzIHN0cmluZykgfHwgY2xpZW50RGF0YUZvckd0bT8uZW1haWwgfHwgXCJcIixcclxuICAgICAgICBwaG9uZTogKHN1Ym1pc3Npb24ucGhvbmUgYXMgc3RyaW5nKSB8fCBjbGllbnREYXRhRm9yR3RtPy5waG9uZSB8fCBcIlwiLFxyXG4gICAgICAgIGZpcnN0TmFtZTogKHN1Ym1pc3Npb24uZmlyc3RfbmFtZSBhcyBzdHJpbmcpIHx8IFwiXCIsXHJcbiAgICAgICAgbGFzdE5hbWU6IChzdWJtaXNzaW9uLmxhc3RfbmFtZSBhcyBzdHJpbmcpIHx8IFwiXCIsXHJcbiAgICAgICAgcG9zdGFsQ29kZTogKHN1Ym1pc3Npb24ucG9zdGFsX2NvZGUgYXMgc3RyaW5nKSB8fCBcIlwiLFxyXG4gICAgICAgIGNvdW50cnk6IChzdWJtaXNzaW9uLmNvdW50cnkgYXMgc3RyaW5nKSB8fCBcIlwiLFxyXG4gICAgICB9LFxyXG4gICAgICBzZWxlY3RlZFNlcnZpY2VzLFxyXG4gICAgICBpc0ZpcnN0UHVyY2hhc2UsXHJcbiAgICAgIHNlcnZpY2VzQ291bnQ6IHNlbGVjdGVkU2VydmljZXMubGVuZ3RoLFxyXG4gICAgfSk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJbdmVyaWZ5LXBheW1lbnRdIEVycm9yOlwiLCBlcnJvcik7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgIHtcclxuICAgICAgICB2ZXJpZmllZDogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJWZXJpZmljYXRpb24gZmFpbGVkXCIsXHJcbiAgICAgIH0sXHJcbiAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl0sIm5hbWVzIjpbIk5leHRSZXNwb25zZSIsIlN0cmlwZSIsImNyZWF0ZUFkbWluQ2xpZW50IiwiUE9TVCIsInJlcXVlc3QiLCJib2R5IiwianNvbiIsInNlc3Npb25JZCIsInZlcmlmaWVkIiwiZXJyb3IiLCJzdGF0dXMiLCJzdHJpcGVTZWNyZXRLZXkiLCJwcm9jZXNzIiwiZW52IiwiU1RSSVBFX1NFQ1JFVF9LRVkiLCJzdHJpcGUiLCJhcGlWZXJzaW9uIiwic3VwYWJhc2UiLCJzZXNzaW9uIiwiY2hlY2tvdXQiLCJzZXNzaW9ucyIsInJldHJpZXZlIiwiZXhwYW5kIiwicGF5bWVudF9zdGF0dXMiLCJpbnZvaWNlVXJsIiwiaW52b2ljZSIsImhvc3RlZF9pbnZvaWNlX3VybCIsImludm9pY2VfcGRmIiwicGF5bWVudF9pbnRlbnQiLCJjaGFyZ2VzIiwibGlzdCIsImlkIiwibGltaXQiLCJkYXRhIiwibGVuZ3RoIiwicmVjZWlwdF91cmwiLCJzdWJtaXNzaW9uSWQiLCJtZXRhZGF0YSIsInN1Ym1pc3Npb25faWQiLCJhY2NvdW50Q3JlYXRlZCIsImFjY291bnRfY3JlYXRlZCIsImV4aXN0aW5nU3VibWlzc2lvbiIsImZldGNoRXJyb3IiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiLCJzdWJtaXNzaW9uIiwic3VibWlzc2lvbkRhdGEiLCJtZXNzYWdlIiwiYW1vdW50IiwiYW1vdW50X3RvdGFsIiwiY3VycmVuY3kiLCJ0b1VwcGVyQ2FzZSIsInRyYW5zYWN0aW9uSWQiLCJ1c2VyRGF0YSIsImVtYWlsIiwicGhvbmUiLCJmaXJzdE5hbWUiLCJmaXJzdF9uYW1lIiwibGFzdE5hbWUiLCJsYXN0X25hbWUiLCJwb3N0YWxDb2RlIiwicG9zdGFsX2NvZGUiLCJjb3VudHJ5Iiwic2VsZWN0ZWRTZXJ2aWNlcyIsImlzRmlyc3RQdXJjaGFzZSIsInNlcnZpY2VzQ291bnQiLCJwYXltZW50SW50ZW50SWQiLCJjdXN0b21lciIsImN1c3RvbWVySWQiLCJwYXltZW50SW50ZW50IiwicGF5bWVudEludGVudHMiLCJwYXltZW50TWV0aG9kSWQiLCJwYXltZW50X21ldGhvZCIsImxhdGVzdF9jaGFyZ2UiLCJjaGFyZ2VJZCIsImNoYXJnZSIsInNldHVwX2ludGVudCIsInNldHVwSW50ZW50SWQiLCJzZXR1cEludGVudCIsInNldHVwSW50ZW50cyIsInBheW1lbnRNZXRob2QiLCJwYXltZW50TWV0aG9kcyIsImF0dGFjaCIsImN1c3RvbWVycyIsInVwZGF0ZSIsImludm9pY2Vfc2V0dGluZ3MiLCJkZWZhdWx0X3BheW1lbnRfbWV0aG9kIiwiY2xpZW50X2lkIiwiY2xpZW50Um93IiwiY3VycmVudFN0cmlwZUlkIiwic3RyaXBlX2N1c3RvbWVyX2lkIiwidXBkYXRlZERhdGEiLCJwYXltZW50Iiwic3RyaXBlX3Nlc3Npb25faWQiLCJwYXltZW50X2ludGVudF9pZCIsImFtb3VudF9wYWlkIiwicGFpZF9hdCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsImludm9pY2VfdXJsIiwidXBkYXRlZFN1Ym1pc3Npb24iLCJ1cGRhdGVFcnJvciIsInVwbG9hZGVkRmlsZXMiLCJmaWxlRW50cmllcyIsIm1hcCIsImZpbGUiLCJmaWxlX25hbWUiLCJuYW1lIiwiZmlsZV91cmwiLCJwdWJsaWNfdXJsIiwiZmlsZV90eXBlIiwidHlwZSIsImZpbGVfc2l6ZSIsInNpemUiLCJzdG9yYWdlX3BhdGgiLCJpbnNlcnQiLCJzaWduYXRvcmllc0RhdGEiLCJzaWduYXRvcmllcyIsInNpZ25hdG9yaWVzQnlEb2N1bWVudCIsImV4aXN0aW5nU2lnbmF0b3JpZXMiLCJzaWduYXRvcnlFbnRyaWVzIiwic2VydmljZURvY3VtZW50cyIsImFsbERvY0tleXMiLCJPYmplY3QiLCJlbnRyaWVzIiwiZm9yRWFjaCIsInNlcnZpY2VJZCIsImRvY3VtZW50cyIsIkFycmF5IiwiaXNBcnJheSIsImRvYyIsImRvY0luZGV4IiwicHVzaCIsImRvY0tleXNUb1VzZSIsInNpZ25hdG9yeSIsImRvY0tleSIsImRvY3VtZW50X2tleSIsImJpcnRoX2RhdGUiLCJiaXJ0aERhdGUiLCJiaXJ0aF9jaXR5IiwiYmlydGhDaXR5IiwicG9zdGFsX2FkZHJlc3MiLCJwb3N0YWxBZGRyZXNzIiwicyIsInN1Ym1pc3Npb25OdW1iZXIiLCJzdWJzdHJpbmciLCJjbGllbnREYXRhIiwiY2xpZW50TmFtZSIsInRyaW0iLCJmdW5jdGlvbnMiLCJpbnZva2UiLCJlbWFpbF90eXBlIiwicmVjaXBpZW50X2VtYWlsIiwicmVjaXBpZW50X25hbWUiLCJyZWNpcGllbnRfdHlwZSIsInN1Ym1pc3Npb25fbnVtYmVyIiwicGF5bWVudF9hbW91bnQiLCJwYXltZW50X2RhdGUiLCJhY3RpdmVOb3RhcmllcyIsIlByb21pc2UiLCJhbGxTZXR0bGVkIiwibm90YXJ5IiwiZnVsbF9uYW1lIiwiY2xpZW50X25hbWUiLCJhcHBvaW50bWVudF9kYXRlIiwiYXBwb2ludG1lbnRfdGltZSIsImNsaWVudF90aW1lem9uZSIsInRpbWV6b25lIiwibm90YXJ5X3RpbWV6b25lIiwiYWRkcmVzcyIsImNpdHkiLCJyZXNvbHZlIiwiY2xpZW50RGF0YUZvckd0bSIsImNsaWVudCIsImNvdW50IiwiaGVhZCIsImluIiwic2VsZWN0ZWRTZXJ2aWNlSWRzIiwic2VydmljZXMiLCJzZXJ2aWNlX2lkIiwic2VydmljZV9uYW1lIiwicHJpY2UiLCJiYXNlX3ByaWNlIiwic2lkIiwidG90YWxBbW91bnQiLCJjb25zb2xlIiwiRXJyb3IiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./app/api/verify-payment/route.ts\n");

/***/ }),

/***/ "(rsc)/./lib/supabase/admin.ts":
/*!*******************************!*\
  !*** ./lib/supabase/admin.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   createAdminClient: () => (/* binding */ createAdminClient)\n/* harmony export */ });\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/index.mjs\");\n\n/**\r\n * Supabase admin client with service role key.\r\n * Use only in API routes / server-side for privileged operations.\r\n */ function createAdminClient() {\n    const url = \"https://jlizwheftlnhoifbqeex.supabase.co\";\n    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n    if (!url || !serviceKey) {\n        throw new Error(\"Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\");\n    }\n    return (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__.createClient)(url, serviceKey);\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvc3VwYWJhc2UvYWRtaW4udHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBcUQ7QUFFckQ7OztDQUdDLEdBQ00sU0FBU0M7SUFDZCxNQUFNQyxNQUFNQywwQ0FBb0M7SUFDaEQsTUFBTUcsYUFBYUgsUUFBUUMsR0FBRyxDQUFDRyx5QkFBeUI7SUFFeEQsSUFBSSxDQUFDTCxPQUFPLENBQUNJLFlBQVk7UUFDdkIsTUFBTSxJQUFJRSxNQUFNO0lBQ2xCO0lBRUEsT0FBT1IsbUVBQVlBLENBQUNFLEtBQUtJO0FBQzNCIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vY2xpZW50LWRhc2hib2FyZC8uL2xpYi9zdXBhYmFzZS9hZG1pbi50cz84MTZiIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUNsaWVudCB9IGZyb20gXCJAc3VwYWJhc2Uvc3VwYWJhc2UtanNcIjtcclxuXHJcbi8qKlxyXG4gKiBTdXBhYmFzZSBhZG1pbiBjbGllbnQgd2l0aCBzZXJ2aWNlIHJvbGUga2V5LlxyXG4gKiBVc2Ugb25seSBpbiBBUEkgcm91dGVzIC8gc2VydmVyLXNpZGUgZm9yIHByaXZpbGVnZWQgb3BlcmF0aW9ucy5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVBZG1pbkNsaWVudCgpIHtcclxuICBjb25zdCB1cmwgPSBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkw7XHJcbiAgY29uc3Qgc2VydmljZUtleSA9IHByb2Nlc3MuZW52LlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVk7XHJcblxyXG4gIGlmICghdXJsIHx8ICFzZXJ2aWNlS2V5KSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJNaXNzaW5nIFNVUEFCQVNFX1VSTCBvciBTVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZXCIpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGNyZWF0ZUNsaWVudCh1cmwsIHNlcnZpY2VLZXkpO1xyXG59XHJcbiJdLCJuYW1lcyI6WyJjcmVhdGVDbGllbnQiLCJjcmVhdGVBZG1pbkNsaWVudCIsInVybCIsInByb2Nlc3MiLCJlbnYiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJzZXJ2aWNlS2V5IiwiU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSIsIkVycm9yIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./lib/supabase/admin.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/tslib","vendor-chunks/iceberg-js","vendor-chunks/stripe","vendor-chunks/math-intrinsics","vendor-chunks/es-errors","vendor-chunks/qs","vendor-chunks/call-bind-apply-helpers","vendor-chunks/get-proto","vendor-chunks/object-inspect","vendor-chunks/has-symbols","vendor-chunks/gopd","vendor-chunks/function-bind","vendor-chunks/side-channel","vendor-chunks/side-channel-weakmap","vendor-chunks/side-channel-map","vendor-chunks/side-channel-list","vendor-chunks/hasown","vendor-chunks/get-intrinsic","vendor-chunks/es-object-atoms","vendor-chunks/es-define-property","vendor-chunks/dunder-proto","vendor-chunks/call-bound"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fverify-payment%2Froute&page=%2Fapi%2Fverify-payment%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fverify-payment%2Froute.ts&appDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cjerem%5COneDrive%5CBureau%5CNouveau%20dossier%20(3)%5Cmy-notary-form%5Cclient-dashboard-next&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();